# dockerディレクトリ以下が更新されたときに、Dockerイメージを作成するワークフロー
# このワークフローは、GitHub Actionsを使用して、Dockerイメージをビルドし、ghcrにプッシュします。
name: Build Docker Image

on:
  push:
    paths:
      - 'docker/**'

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Set up QEMU
          uses: docker/setup-qemu-action@v2

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v1

        - name: Login to GitHub Container Registry
          run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

        # イメージをビルドして、ghcrにプッシュする
        # このときに、イメージに対するタグとして、latest以外に"latest-{epoch秒}"も用意する。
        - name: Build and push
          id: docker_build
          uses: docker/build-push-action@v2
          with:
            context: .
            file: ./docker/Dockerfile
            platforms: linux/amd64,linux/arm64
            push: true
            tags: ghcr.io/${{ github.repository }}/app:latest,ghcr.io/${{ github.repository }}/app:latest-$(date +%s)

        - name: Image digest
          run: echo ${{ steps.docker_build.outputs.digest }}
